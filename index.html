<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Farm Management PWA for Dairy and Poultry Farmers">
    <title>Farm Management PWA</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Farm Management">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#4CAF50">
    <meta name="msapplication-TileColor" content="#4CAF50">
    
    <!-- Icons -->
    <link rel="icon" href="icons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
    <script src-"force-refresh.js"></script>
<body>
    <!-- Welcome/Livestock Selection Screen -->
    <div id="welcome-screen" class="screen active">
        <div class="welcome-container">
            <div class="welcome-header">
                <h1 class="welcome-title">ğŸŒ± Farm Management</h1>
                <p class="welcome-subtitle">Manage your dairy and poultry operations efficiently</p>
            </div>
            
            <div class="livestock-selection">
                <div class="selection-card" id="dairy-card" data-livestock="dairy">
                    <div class="card-icon">ğŸ„</div>
                    <h3 class="card-title">Dairy Management</h3>
                    <p class="card-description">Track milk production, herd health, and finances</p>
                    <div class="card-stats">
                        <span>ğŸ“Š Production</span>
                        <span>ğŸ’Š Health</span>
                        <span>ğŸ’° Finance</span>
                    </div>
                </div>
                
                <div class="selection-card" id="poultry-card" data-livestock="poultry">
                    <div class="card-icon">ğŸ”</div>
                    <h3 class="card-title">Poultry Management</h3>
                    <p class="card-description">Monitor egg production, flock health, and costs</p>
                    <div class="card-stats">
                        <span>ğŸ¥š Eggs</span>
                        <span>ğŸ’‰ Health</span>
                        <span>ğŸ“ˆ Growth</span>
                    </div>
                </div>
            </div>
            
            <div class="welcome-actions">
                <button id="backup-btn" class="btn-secondary">
                    <span class="btn-icon">ğŸ’¾</span>
                    Create Backup
                </button>
                <button id="restore-btn" class="btn-secondary">
                    <span class="btn-icon">ğŸ”„</span>
                    Restore Backup
                </button>
                <button id="login-btn" class="btn-primary">
                    <span class="btn-icon">ğŸ‘¤</span>
                    Login / Sign Up
                </button>
            </div>
            
            <div class="welcome-footer">
                <p class="offline-status" id="offline-status">âœ… Online - Data will sync automatically</p>
                <p class="app-version">Version 1.0.0 â€¢ PWA Ready</p>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="app-screen" class="screen">
        <!-- Top Header -->
        <header class="app-header">
            <div class="header-left">
                <button id="menu-btn" class="icon-btn">
                    <span>â˜°</span>
                </button>
                <h1 id="page-title">Dashboard</h1>
            </div>
            <div class="header-right">
                <button id="sync-btn" class="icon-btn" title="Sync Status">
                    <span>ğŸ”„</span>
                    <span id="sync-status" class="sync-dot"></span>
                </button>
                <button id="user-btn" class="avatar-btn">
                    <span>ğŸ‘¤</span>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="content-area">
            <!-- Content will be dynamically loaded here -->
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="dashboard">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-label">Dashboard</span>
            </button>
            <button class="nav-btn" data-page="history">
                <span class="nav-icon">ğŸ“œ</span>
                <span class="nav-label">History</span>
            </button>
            <button class="nav-btn" data-page="finance">
                <span class="nav-icon">ğŸ’°</span>
                <span class="nav-label">Finance</span>
            </button>
            <button class="nav-btn" data-page="health">
                <span class="nav-icon">â¤ï¸</span>
                <span class="nav-label">Health</span>
            </button>
            <button class="nav-btn" data-page="reports">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-label">Reports</span>
            </button>
            <button class="nav-btn" data-page="settings">
                <span class="nav-icon">âš™ï¸</span>
                <span class="nav-label">Settings</span>
            </button>
            <button id="add-herd-btn" class="nav-btn" style="display: none;">
                <span class="nav-icon">ğŸ„</span>
                <span class="nav-label">Add Herd</span>
            </button>
        </nav>

        <!-- Floating Action Button -->
        <button id="fab" class="fab">
            <span>+</span>
        </button>

        <!-- FAB Modal -->
        <div id="fab-modal" class="modal">
            <div class="modal-content fab-modal">
                <div class="modal-header">
                    <h3>Add New Record</h3>
                    <button class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <button class="fab-option" data-form="production">
                        <span class="option-icon">ğŸ¥›</span>
                        <div class="option-text">
                            <strong>Production Record</strong>
                            <small>Add milk/egg production</small>
                        </div>
                    </button>
                    <button class="fab-option" data-form="financial">
                        <span class="option-icon">ğŸ’°</span>
                        <div class="option-text">
                            <strong>Financial Transaction</strong>
                            <small>Add income or expense</small>
                        </div>
                    </button>
                    <button class="fab-option" data-form="health">
                        <span class="option-icon">ğŸ’Š</span>
                        <div class="option-text">
                            <strong>Health Record</strong>
                            <small>Add treatment or vaccination</small>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content auth-modal">
            <div class="modal-header">
                <h3>Login / Sign Up</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="auth-form">
                    <div class="form-group">
                        <label for="auth-email">Email</label>
                        <input type="email" id="auth-email" required>
                    </div>
                    <div class="form-group">
                        <label for="auth-password">Password</label>
                        <input type="password" id="auth-password" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" id="submit-auth" class="btn-primary">Login</button>
                        <button type="button" id="switch-auth" class="btn-secondary">Switch to Sign Up</button>
                    </div>
                </form>
                <div id="auth-status" class="auth-status"></div>
            </div>
        </div>
    </div>

    <!-- Production Form Modal -->
    <div id="production-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Production Record</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="production-form">
                    <div class="form-group">
                        <label for="prod-date">Date</label>
                        <input type="date" id="prod-date" required value="<?php echo date('Y-m-d'); ?>">
                    </div>
                    <div class="form-group">
                        <label for="prod-type">Type</label>
                        <select id="prod-type" required>
                            <option value="milk">Milk Production</option>
                            <option value="eggs">Egg Production</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="prod-quantity">Quantity</label>
                        <input type="number" id="prod-quantity" step="0.01" required placeholder="e.g., 50">
                    </div>
                    <div class="form-group">
                        <label for="prod-unit">Unit</label>
                        <select id="prod-unit">
                            <option value="liters">Liters</option>
                            <option value="eggs">Eggs</option>
                            <option value="kg">Kilograms</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="prod-notes">Notes</label>
                        <textarea id="prod-notes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Save Record</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/sync.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/forms.js"></script>
    <script src="js/pdf.js"></script>
    <script src="js/app.js"></script>

    <!-- Service Worker Registration -->
    <script>
        // Force clear any existing service workers first
        if ('serviceWorker' in navigator) {
            // Unregister all service workers for this scope
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                    console.log('Unregistered old service worker:', registration.scope);
                }
            }).then(() => {
                // Wait a bit, then register new service worker
                setTimeout(() => {
                    navigator.serviceWorker.register('sw.js', { scope: './' })
                        .then(registration => {
                            console.log('New Service Worker registered with scope:', registration.scope);
                            // Force update
                            registration.update();
                        })
                        .catch(error => {
                            console.log('Service Worker registration failed:', error);
                        });
                }, 1000);
            });
        }
    
        // Check online status with better error handling
        function updateOnlineStatus() {
            const offlineStatus = document.getElementById('offline-status');
            if (offlineStatus) {
                offlineStatus.textContent = navigator.onLine 
                    ? 'âœ… Online - Ready to use' 
                    : 'âš ï¸ Offline - Working locally';
            }
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus(); // Initial call
    </script>
</body>
</html>
